name: prepare release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g. 0.21.6 or 0.22.0)'
        required: true

jobs:
  push:
    name: Prepare release PR
    runs-on: ubuntu-latest

    permissions:
      id-token: write # IMPORTANT: this permission is mandatory for trusted publishing
      contents: write # required to push release branch and open PR
      pull-requests: write # required to create the release PR with GITHUB_TOKEN
      workflows: write # required to update workflow file with new version

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Bump version.rb
        run: |
          set -euo pipefail
          version="${{ github.event.inputs.version }}"
          version="${version#v}"

          echo "VERSION_NO_V=$version" >> "$GITHUB_ENV"
          echo "VERSION_TAG=v$version" >> "$GITHUB_ENV"

          current_version=$(ruby -e "require_relative './lib/rspec/openapi/version'; puts RSpec::OpenAPI::VERSION")
          VERSION_NO_V="$version" CURRENT_VERSION="$current_version" ruby - <<'RUBY'
            version = ENV.fetch('VERSION_NO_V')
            unless version.match?(/\A\d+(?:\.\d+)*\z/)
              warn "Invalid version format: #{version}"
              exit 1
            end

            require 'rubygems'
            new_version = Gem::Version.new(version)
            current_version = Gem::Version.new(ENV.fetch('CURRENT_VERSION'))
            if new_version <= current_version
              warn "Given version (#{new_version}) must be newer than current version (#{current_version})"
              exit 1
            end
          RUBY
          ruby -pi -e "sub(/VERSION = .*/, \"VERSION = '$version'\")" lib/rspec/openapi/version.rb

          VERSION_NO_V="$version" ruby - <<'RUBY'
            version = ENV.fetch('VERSION_NO_V')
            segments = version.split('.').map(&:to_i)
            unless segments.size >= 3
              warn "Version must have at least major.minor.patch: #{version}"
              exit 1
            end

            major, minor, patch = segments
            patch_bump = [major, minor, patch + 1].join('.')
            minor_bump = [major, minor + 1, 0].join('.')
            example = "Version to release (e.g. #{patch_bump} or #{minor_bump})"

            path = ".github/workflows/create_release.yml"
            content = File.read(path)
            content.sub!(/description:\s*'Version to release \(e\.g\. [^']+\)'/,
                         "description: '#{example}'")
            File.write(path, content)
          RUBY
          git status --short

      - name: Commit version bump
        run: |
          set -euo pipefail
          version="$VERSION_NO_V"

          release_branch="release/v${version}"
          echo "RELEASE_BRANCH=${release_branch}" >> "$GITHUB_ENV"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -am "Bump version to ${version}"
          git push origin "HEAD:${release_branch}"

      - name: Open release PR
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          add-paths: |
            lib/rspec/openapi/version.rb
            .github/workflows/create_release.yml
          branch: ${{ env.RELEASE_BRANCH }}
          title: Release v${{ env.VERSION_NO_V }}
          commit-message: Bump version to ${{ env.VERSION_NO_V }}
          body: |
            Automated release PR created by workflow_dispatch.
            - Version: v${{ env.VERSION_NO_V }}
            - Triggered by: ${{ github.actor }}
